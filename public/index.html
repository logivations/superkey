<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Superkey - SSH Key Management</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸ”‘</text></svg>">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f5; }
    .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
    header { background: #1a73e8; color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; }
    header h1 { font-size: 1.5rem; }
    .user-info { display: flex; align-items: center; gap: 15px; }
    .user-info span { font-size: 0.9rem; }
    .btn { padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9rem; transition: background 0.2s; }
    .btn-primary { background: #1a73e8; color: white; }
    .btn-primary:hover { background: #1557b0; }
    .btn-secondary { background: #fff; color: #1a73e8; border: 1px solid #1a73e8; }
    .btn-secondary:hover { background: #e8f0fe; }
    .btn-danger { background: #dc3545; color: white; }
    .btn-danger:hover { background: #c82333; }
    .btn-small { padding: 4px 8px; font-size: 0.8rem; }
    nav { background: #fff; border-bottom: 1px solid #ddd; padding: 0 20px; }
    nav ul { list-style: none; display: flex; gap: 0; }
    nav li { padding: 15px 20px; cursor: pointer; border-bottom: 3px solid transparent; }
    nav li:hover { background: #f5f5f5; }
    nav li.active { border-bottom-color: #1a73e8; color: #1a73e8; }
    .card { background: white; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); padding: 20px; margin-bottom: 20px; }
    .card h2 { margin-bottom: 15px; font-size: 1.2rem; color: #333; }
    .form-group { margin-bottom: 15px; }
    .form-group label { display: block; margin-bottom: 5px; font-weight: 500; }
    .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem; }
    .form-group textarea { min-height: 100px; font-family: monospace; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
    th { background: #f9f9f9; font-weight: 500; }
    tr:hover { background: #f5f5f5; }
    .tag { display: inline-block; padding: 3px 8px; background: #e8f0fe; color: #1a73e8; border-radius: 12px; font-size: 0.8rem; margin: 2px; }
    .tag-green { background: #e6f4ea; color: #137333; }
    .tag-yellow { background: #fef7cd; color: #856404; }
    .tag-red { background: #f8d7da; color: #721c24; }
    .sync-status { display: flex; align-items: center; gap: 5px; }
    .sync-status .dot { width: 8px; height: 8px; border-radius: 50%; }
    .sync-status .dot-green { background: #28a745; }
    .sync-status .dot-yellow { background: #ffc107; }
    .sync-status .dot-gray { background: #6c757d; }
    .hidden { display: none !important; }
    .login-container { display: flex; justify-content: center; align-items: center; height: 100vh; }
    .login-box { text-align: center; }
    .login-box h1 { margin-bottom: 20px; }
    .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 1000; }
    .modal-content { background: white; padding: 30px; border-radius: 8px; width: 500px; max-width: 90%; max-height: 80vh; overflow-y: auto; }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .modal-close { font-size: 1.5rem; cursor: pointer; color: #666; }
    .access-section { margin-top: 15px; }
    .access-section h4 { margin-bottom: 10px; color: #666; }
    .flex-row { display: flex; gap: 10px; align-items: center; }
    .chip-input { display: flex; flex-wrap: wrap; gap: 5px; padding: 5px; border: 1px solid #ddd; border-radius: 4px; min-height: 40px; }
    .chip-input input { border: none; outline: none; flex: 1; min-width: 100px; padding: 5px; }
    .alert { padding: 12px; border-radius: 4px; margin-bottom: 15px; }
    .alert-success { background: #d4edda; color: #155724; }
    .alert-error { background: #f8d7da; color: #721c24; }
    .logos { display: flex; align-items: center; gap: 15px; }
    .logos img { height: 32px; width: auto; }
    .login-logos { display: flex; justify-content: center; align-items: center; gap: 20px; margin-bottom: 30px; }
    .login-logos img { height: 40px; width: auto; }
  </style>
</head>
<body>
  <div id="app">
    <!-- Login View -->
    <div id="login-view" class="login-container hidden">
      <div class="login-box">
        <div class="login-logos">
          <img src="/images/logivations-1-1024x256.webp" alt="Logivations">
          <img src="/images/logo_PixelRobotics-1-scaled.png" alt="PixelRobotics">
        </div>
        <h1>Superkey</h1>
        <p style="margin-bottom: 20px; color: #666;">SSH Key Management Tool</p>
        <a href="/auth/google" class="btn btn-primary">Sign in with Google</a>
        <p style="margin-top: 20px;"><a href="https://coda.io/d/_dFse1sx3aih/Superkey_su1T4vqT" target="_blank" style="color: #666; font-size: 0.9rem;">Documentation</a></p>
      </div>
    </div>

    <!-- Main App -->
    <div id="main-view" class="hidden">
      <header>
        <div class="logos">
          <img src="/images/logivations-1-1024x256.webp" alt="Logivations">
          <img src="/images/logo_PixelRobotics-1-scaled.png" alt="PixelRobotics">
          <h1>Superkey</h1>
        </div>
        <div class="user-info">
          <span id="user-name"></span>
          <span id="admin-badge" class="tag tag-green hidden">Admin</span>
          <a href="/auth/logout" class="btn btn-secondary">Logout</a>
        </div>
      </header>

      <nav>
        <ul>
          <li class="active" data-tab="my-key">My Key</li>
          <li data-tab="my-access">My Access</li>
          <li class="admin-only hidden" data-tab="servers">Servers</li>
          <li class="admin-only hidden" data-tab="labels">Labels</li>
          <li class="admin-only hidden" data-tab="groups">Groups</li>
          <li class="admin-only hidden" data-tab="users">Users</li>
          <li class="admin-only hidden" data-tab="access-admin">Access Admin</li>
        </ul>
      </nav>

      <div class="container">
        <!-- My Key Tab -->
        <div id="tab-my-key" class="tab-content">
          <div class="card">
            <h2>My SSH Public Key</h2>
            <div class="form-group">
              <label for="public-key">Paste your SSH public key here:</label>
              <textarea id="public-key" placeholder="ssh-ed25519 AAAA... user@hostname"></textarea>
            </div>
            <button class="btn btn-primary" onclick="savePublicKey()">Save Key</button>
            <div id="key-message" class="alert hidden" style="margin-top: 15px;"></div>
          </div>

          <div class="card">
            <h2>How to Get Your SSH Public Key</h2>

            <div class="instructions">
              <h4 style="margin-bottom: 10px;">If you already have an SSH key:</h4>
              <p style="margin-bottom: 10px; color: #666;">Your public key is usually located at <code>~/.ssh/id_ed25519.pub</code> or <code>~/.ssh/id_rsa.pub</code></p>

              <div style="background: #f5f5f5; padding: 12px; border-radius: 4px; margin-bottom: 15px; font-family: monospace; font-size: 0.9rem;">
                <strong>Linux/macOS:</strong><br>
                cat ~/.ssh/id_ed25519.pub<br><br>
                <strong>Windows (PowerShell):</strong><br>
                Get-Content $env:USERPROFILE\.ssh\id_ed25519.pub
              </div>

              <h4 style="margin-bottom: 10px;">If you need to generate a new key:</h4>
              <p style="margin-bottom: 10px; color: #666;">Run the following command in your terminal:</p>

              <div style="background: #f5f5f5; padding: 12px; border-radius: 4px; margin-bottom: 15px; font-family: monospace; font-size: 0.9rem;">
                ssh-keygen -t ed25519 -C "your_email@lvairo.com"
              </div>

              <p style="margin-bottom: 10px; color: #666;">Then press Enter to accept the default location, and optionally set a passphrase.</p>

              <p style="margin-bottom: 10px; color: #666;">After generating, copy the contents of the <code>.pub</code> file (the public key) and paste it above.</p>

              <div style="background: #fff3cd; padding: 12px; border-radius: 4px; color: #856404;">
                <strong>Important:</strong> Only share your <strong>public key</strong> (.pub file). Never share your private key (the file without .pub extension).
              </div>
            </div>
          </div>
        </div>

        <!-- My Access Tab -->
        <div id="tab-my-access" class="tab-content hidden">
          <div class="card">
            <h2>Servers I Have Access To</h2>
            <table>
              <thead>
                <tr><th>Hostname</th><th>Description</th><th>Sync Status</th></tr>
              </thead>
              <tbody id="my-servers-list"></tbody>
            </table>
          </div>
        </div>

        <!-- Servers Tab (Admin) -->
        <div id="tab-servers" class="tab-content hidden">
          <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
              <h2>Servers</h2>
              <button class="btn btn-secondary" onclick="importServers()">Import from SSH Configs</button>
            </div>
            <div id="import-status" class="alert hidden" style="margin-bottom: 15px;"></div>
            <table>
              <thead>
                <tr><th>Hostname</th><th>Description</th><th>Labels</th><th>Sync Status</th><th>Actions</th></tr>
              </thead>
              <tbody id="servers-list"></tbody>
            </table>
          </div>
        </div>

        <!-- Labels Tab (Admin) -->
        <div id="tab-labels" class="tab-content hidden">
          <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
              <h2>Labels</h2>
              <button class="btn btn-primary" onclick="showAddLabelModal()">Add Label</button>
            </div>
            <table>
              <thead>
                <tr><th>Name</th><th>Groups with Access</th><th>Actions</th></tr>
              </thead>
              <tbody id="labels-list"></tbody>
            </table>
          </div>
        </div>

        <!-- Groups Tab (Admin) -->
        <div id="tab-groups" class="tab-content hidden">
          <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
              <h2>Groups</h2>
              <button class="btn btn-secondary" onclick="syncAllGroups()">Sync from Google</button>
            </div>
            <div id="sync-status" class="alert hidden" style="margin-bottom: 15px;"></div>
            <p style="margin-bottom: 15px; color: #666; font-size: 0.9rem;">
              Group membership is synced from Google Workspace. Set up a service account for automatic sync.
            </p>
            <table>
              <thead>
                <tr><th>Name</th><th>Google Group Email</th><th>Members</th></tr>
              </thead>
              <tbody id="groups-list"></tbody>
            </table>
          </div>
        </div>

        <!-- Users Tab (Admin) -->
        <div id="tab-users" class="tab-content hidden">
          <div class="card">
            <h2>Users</h2>
            <table>
              <thead>
                <tr><th>Name</th><th>Email</th><th>Has Public Key</th><th>Actions</th></tr>
              </thead>
              <tbody id="users-list"></tbody>
            </table>
          </div>
        </div>

        <!-- Access Admin Tab -->
        <div id="tab-access-admin" class="tab-content hidden">
          <div class="card">
            <h2>Admin: View User Access</h2>
            <div class="form-group">
              <label>Select a user:</label>
              <select id="admin-user-select" onchange="loadUserServers()">
                <option value="">-- Select User --</option>
              </select>
            </div>
            <table id="admin-user-servers" class="hidden">
              <thead>
                <tr><th>Hostname</th><th>Description</th><th>Sync Status</th></tr>
              </thead>
              <tbody id="admin-user-servers-list"></tbody>
            </table>
          </div>

          <div class="card">
            <h2>Admin: View Server Access</h2>
            <div class="form-group">
              <label>Select a server:</label>
              <select id="admin-server-select" onchange="loadServerAccess()">
                <option value="">-- Select Server --</option>
              </select>
            </div>
            <div id="server-access-info" class="hidden">
              <div class="access-section">
                <h4>Users with Access</h4>
                <table>
                  <thead><tr><th>User</th><th>Email</th><th>Via Group</th><th>Has Key</th></tr></thead>
                  <tbody id="server-access-users"></tbody>
                </table>
              </div>
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>

  <!-- Manage Server Labels Modal -->
  <div id="server-modal" class="modal hidden">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Manage Server Labels</h3>
        <span class="modal-close" onclick="closeModal('server-modal')">&times;</span>
      </div>
      <input type="hidden" id="server-id">
      <div class="form-group">
        <label>Hostname</label>
        <div style="padding: 10px; background: #f5f5f5; border-radius: 4px; font-family: monospace;" id="server-hostname-display"></div>
      </div>
      <div class="form-group">
        <label>Description</label>
        <div style="padding: 10px; background: #f5f5f5; border-radius: 4px; color: #666;" id="server-description-display">-</div>
      </div>
      <div class="access-section">
        <h4>Labels</h4>
        <div class="flex-row" style="margin-bottom: 10px;">
          <select id="add-label-to-server">
            <option value="">-- Add Label --</option>
          </select>
          <button class="btn btn-small btn-primary" onclick="addLabelToServer()">Add</button>
        </div>
        <div id="server-labels-list"></div>
      </div>
    </div>
  </div>

  <!-- Add Label Modal -->
  <div id="label-modal" class="modal hidden">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Add Label</h3>
        <span class="modal-close" onclick="closeModal('label-modal')">&times;</span>
      </div>
      <form onsubmit="saveLabel(event)">
        <div class="form-group">
          <label>Label Name</label>
          <input type="text" id="label-name" required>
        </div>
        <button type="submit" class="btn btn-primary">Save</button>
      </form>
    </div>
  </div>

  <!-- Manage Label Access Modal -->
  <div id="label-access-modal" class="modal hidden">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Manage Access: <span id="label-access-name"></span></h3>
        <span class="modal-close" onclick="closeModal('label-access-modal')">&times;</span>
      </div>
      <input type="hidden" id="label-access-id">
      <div class="access-section">
        <h4>Groups with Access</h4>
        <div class="flex-row" style="margin-bottom: 10px;">
          <select id="add-group-to-label">
            <option value="">-- Add Group --</option>
          </select>
          <button class="btn btn-small btn-primary" onclick="addGroupToLabel()">Add</button>
        </div>
        <div id="label-groups-list"></div>
      </div>
    </div>
  </div>

  <script>
    let currentUser = null;
    let allUsers = [];
    let allGroups = [];
    let allLabels = [];
    let allServers = [];

    // Initialize
    async function init() {
      try {
        const res = await fetch('/api/me');
        if (res.ok) {
          currentUser = await res.json();
          showMainView();
        } else {
          showLoginView();
        }
      } catch {
        showLoginView();
      }
    }

    function showLoginView() {
      document.getElementById('login-view').classList.remove('hidden');
      document.getElementById('main-view').classList.add('hidden');
    }

    function showMainView() {
      document.getElementById('login-view').classList.add('hidden');
      document.getElementById('main-view').classList.remove('hidden');
      document.getElementById('user-name').textContent = currentUser.name || currentUser.email;

      if (currentUser.isAdmin) {
        document.getElementById('admin-badge').classList.remove('hidden');
        document.querySelectorAll('.admin-only').forEach(el => el.classList.remove('hidden'));
      }

      document.getElementById('public-key').value = currentUser.public_key || '';
      loadMyServers();
      if (currentUser.isAdmin) {
        loadAllData();
      }

      // Restore previously active tab after admin tabs are revealed
      restoreActiveTab();
    }

    // Tab navigation
    document.querySelectorAll('nav li').forEach(tab => {
      tab.addEventListener('click', () => {
        switchToTab(tab.dataset.tab);
      });
    });

    function switchToTab(tabName) {
      document.querySelectorAll('nav li').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
      const tab = document.querySelector(`nav li[data-tab="${tabName}"]`);
      if (tab) {
        tab.classList.add('active');
        document.getElementById('tab-' + tabName).classList.remove('hidden');
        localStorage.setItem('superkey-active-tab', tabName);
      }
    }

    function restoreActiveTab() {
      const savedTab = localStorage.getItem('superkey-active-tab');
      if (savedTab) {
        const tab = document.querySelector(`nav li[data-tab="${savedTab}"]`);
        // Only restore if the tab exists and is visible (for admin tabs)
        if (tab && !tab.classList.contains('hidden')) {
          switchToTab(savedTab);
        }
      }
    }

    // API helpers
    async function api(url, options = {}) {
      const res = await fetch(url, {
        ...options,
        headers: { 'Content-Type': 'application/json', ...options.headers }
      });
      if (!res.ok) {
        const err = await res.json().catch(() => ({ error: 'Request failed' }));
        throw new Error(err.error);
      }
      return res.json();
    }

    // Public key
    async function savePublicKey() {
      const key = document.getElementById('public-key').value;
      const msg = document.getElementById('key-message');
      try {
        await api('/api/me/public-key', { method: 'PUT', body: JSON.stringify({ publicKey: key }) });
        msg.className = 'alert alert-success';
        msg.textContent = 'Public key saved successfully!';
      } catch (e) {
        msg.className = 'alert alert-error';
        msg.textContent = e.message;
      }
      msg.classList.remove('hidden');
    }

    // My servers
    async function loadMyServers() {
      const servers = await api('/api/my-servers');
      const list = document.getElementById('my-servers-list');
      list.innerHTML = servers.length ? servers.map(s => {
        let syncStatus;
        if (!s.last_deployed_at) {
          syncStatus = '<div class="sync-status"><span class="dot dot-gray"></span> Never deployed</div>';
        } else if (s.is_up_to_date) {
          syncStatus = '<div class="sync-status"><span class="dot dot-green"></span> Up to date</div>';
        } else {
          syncStatus = '<div class="sync-status"><span class="dot dot-yellow"></span> Needs sync</div>';
        }
        return `<tr><td>${s.hostname}</td><td>${s.description || '-'}</td><td>${syncStatus}</td></tr>`;
      }).join('') : '<tr><td colspan="3">No servers accessible</td></tr>';
    }

    // Load all data (admin)
    async function loadAllData() {
      [allUsers, allGroups, allLabels, allServers] = await Promise.all([
        api('/api/users'),
        api('/api/groups'),
        api('/api/labels'),
        api('/api/servers')
      ]);
      renderServers();
      renderLabels();
      renderGroups();
      renderUsers();
      populateAdminSelects();
    }

    function renderServers() {
      document.getElementById('servers-list').innerHTML = allServers.map(s => {
        let syncStatus;
        if (!s.last_deployed_at) {
          syncStatus = '<div class="sync-status"><span class="dot dot-gray"></span> Never deployed</div>';
        } else if (s.is_up_to_date) {
          const deployedDate = new Date(s.last_deployed_at).toLocaleDateString();
          syncStatus = `<div class="sync-status"><span class="dot dot-green"></span> Up to date (${deployedDate})</div>`;
        } else {
          const deployedDate = new Date(s.last_deployed_at).toLocaleDateString();
          syncStatus = `<div class="sync-status"><span class="dot dot-yellow"></span> Needs sync (${deployedDate})</div>`;
        }
        return `
          <tr>
            <td>${s.hostname}</td>
            <td>${s.description || '-'}</td>
            <td>${s.labels.map(l => `<span class="tag">${l}</span>`).join('') || '<span style="color:#999">No labels</span>'}</td>
            <td>${syncStatus}</td>
            <td>
              <button class="btn btn-small btn-secondary" onclick="manageServerLabels(${s.id})">Labels</button>
              <button class="btn btn-small btn-secondary" onclick="downloadServerSetup(${s.id}, '${s.hostname}')" title="Download setup package for manual deployment">&#8595;</button>
            </td>
          </tr>
        `;
      }).join('');
    }

    async function renderLabels() {
      const rows = await Promise.all(allLabels.map(async l => {
        const groups = await api(`/api/labels/${l.id}/groups`);
        return `
          <tr>
            <td>${l.name}</td>
            <td>${groups.map(g => `<span class="tag">${g.name}</span>`).join('') || '-'}</td>
            <td>
              <button class="btn btn-small btn-secondary" onclick="manageLabelAccess(${l.id}, '${l.name}')">Manage Access</button>
              <button class="btn btn-small btn-danger" onclick="deleteLabel(${l.id})">Delete</button>
            </td>
          </tr>
        `;
      }));
      document.getElementById('labels-list').innerHTML = rows.join('');
    }

    async function renderGroups() {
      const rows = await Promise.all(allGroups.map(async g => {
        const members = await api(`/api/groups/${g.id}/users`);
        return `
          <tr>
            <td>${g.name}</td>
            <td>${g.google_group_email || '-'}</td>
            <td>${members.length} members</td>
          </tr>
        `;
      }));
      document.getElementById('groups-list').innerHTML = rows.join('');
    }

    function renderUsers() {
      document.getElementById('users-list').innerHTML = allUsers.map(u => `
        <tr>
          <td>${u.name || '-'}</td>
          <td>${u.email}</td>
          <td>${u.public_key ? '<span class="tag tag-green">Yes</span>' : '<span class="tag">No</span>'}</td>
          <td><button class="btn btn-small btn-secondary" onclick="viewUserAccess(${u.id})">View Access</button></td>
        </tr>
      `).join('');
    }

    function populateAdminSelects() {
      const userOptions = allUsers.map(u => `<option value="${u.id}">${u.name || u.email}</option>`).join('');
      const serverOptions = allServers.map(s => `<option value="${s.id}">${s.hostname}</option>`).join('');
      document.getElementById('admin-user-select').innerHTML = '<option value="">-- Select User --</option>' + userOptions;
      document.getElementById('admin-server-select').innerHTML = '<option value="">-- Select Server --</option>' + serverOptions;
    }

    // Modals
    function closeModal(id) {
      document.getElementById(id).classList.add('hidden');
    }

    // Import servers from SSH config files
    async function importServers() {
      const msg = document.getElementById('import-status');
      msg.className = 'alert';
      msg.textContent = 'Importing servers from SSH config files...';
      msg.classList.remove('hidden');

      try {
        const result = await api('/api/import-servers', { method: 'POST' });
        msg.className = 'alert alert-success';
        msg.textContent = `Import complete: ${result.imported} servers imported, ${result.skipped} skipped (already exist). Processed ${result.configFiles} config files.`;
        allServers = await api('/api/servers');
        allLabels = await api('/api/labels');
        renderServers();
        renderLabels();
        populateAdminSelects();
      } catch (e) {
        msg.className = 'alert alert-error';
        msg.textContent = e.message;
      }
    }

    async function manageServerLabels(serverId) {
      const server = allServers.find(s => s.id === serverId);
      document.getElementById('server-id').value = serverId;
      document.getElementById('server-hostname-display').textContent = server.hostname;
      document.getElementById('server-description-display').textContent = server.description || '-';

      // Populate dropdown with labels not already assigned
      const availableLabels = allLabels.filter(l => !server.labels.includes(l.name));
      document.getElementById('add-label-to-server').innerHTML = '<option value="">-- Add Label --</option>' +
        availableLabels.map(l => `<option value="${l.id}">${l.name}</option>`).join('');

      // Show current labels with remove buttons
      document.getElementById('server-labels-list').innerHTML = server.labels.length
        ? server.labels.map(labelName => {
            const label = allLabels.find(l => l.name === labelName);
            return label ? `<span class="tag">${labelName} <span style="cursor:pointer" onclick="removeLabelFromServer(${serverId}, ${label.id})">Ã—</span></span>` : '';
          }).join('')
        : '<span style="color:#999">No labels assigned</span>';

      document.getElementById('server-modal').classList.remove('hidden');
    }

    async function addLabelToServer() {
      const serverId = document.getElementById('server-id').value;
      const labelId = document.getElementById('add-label-to-server').value;
      if (labelId) {
        await api(`/api/servers/${serverId}/labels/${labelId}`, { method: 'POST' });
        allServers = await api('/api/servers');
        renderServers();
        manageServerLabels(parseInt(serverId));
      }
    }

    async function removeLabelFromServer(serverId, labelId) {
      await api(`/api/servers/${serverId}/labels/${labelId}`, { method: 'DELETE' });
      allServers = await api('/api/servers');
      renderServers();
      manageServerLabels(serverId);
    }

    async function downloadServerSetup(serverId, hostname) {
      try {
        const response = await fetch(`/api/servers/${serverId}/download-setup`, {
          credentials: 'include'
        });

        if (!response.ok) {
          const error = await response.json();
          alert('Error: ' + (error.error || 'Failed to generate setup package'));
          return;
        }

        // Create blob and trigger download
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `superkey-setup-${hostname}.tar.gz`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
      } catch (e) {
        alert('Error downloading setup package: ' + e.message);
      }
    }

    function showAddLabelModal() {
      document.getElementById('label-name').value = '';
      document.getElementById('label-modal').classList.remove('hidden');
    }

    async function saveLabel(e) {
      e.preventDefault();
      await api('/api/labels', { method: 'POST', body: JSON.stringify({ name: document.getElementById('label-name').value }) });
      closeModal('label-modal');
      allLabels = await api('/api/labels');
      renderLabels();
    }

    async function deleteLabel(id) {
      if (confirm('Delete this label?')) {
        await api(`/api/labels/${id}`, { method: 'DELETE' });
        allLabels = await api('/api/labels');
        renderLabels();
      }
    }

    // Sync all groups from Google Workspace
    async function syncAllGroups() {
      const msg = document.getElementById('sync-status');
      msg.className = 'alert';
      msg.textContent = 'Syncing groups from Google Workspace...';
      msg.classList.remove('hidden');

      try {
        const result = await api('/api/sync-all-groups', { method: 'POST' });
        msg.className = 'alert alert-success';
        let statusText = `Sync complete: ${result.googleUsers || 0} users, ${result.googleGroups || 0} groups from Google. `;
        statusText += `${result.memberships} memberships synced. `;
        if (result.createdUsers) statusText += `${result.createdUsers} users created. `;
        if (result.removedUsers) statusText += `${result.removedUsers} users removed. `;
        if (result.createdGroups) statusText += `${result.createdGroups} groups created. `;
        if (result.removedGroups) statusText += `${result.removedGroups} groups removed.`;
        msg.textContent = statusText;
        await loadAllData();
        renderGroups();
      } catch (e) {
        msg.className = 'alert alert-error';
        msg.textContent = e.message;
      }
    }

    // Label access management
    async function manageLabelAccess(labelId, labelName) {
      document.getElementById('label-access-id').value = labelId;
      document.getElementById('label-access-name').textContent = labelName;

      // Populate dropdown
      document.getElementById('add-group-to-label').innerHTML = '<option value="">-- Add Group --</option>' +
        allGroups.map(g => `<option value="${g.id}">${g.name}</option>`).join('');

      // Load current access
      const groups = await api(`/api/labels/${labelId}/groups`);

      document.getElementById('label-groups-list').innerHTML = groups.map(g => `
        <span class="tag">${g.name} <span style="cursor:pointer" onclick="removeGroupFromLabel(${labelId}, ${g.id})">Ã—</span></span>
      `).join('') || 'No groups';

      document.getElementById('label-access-modal').classList.remove('hidden');
    }

    async function addGroupToLabel() {
      const labelId = document.getElementById('label-access-id').value;
      const groupId = document.getElementById('add-group-to-label').value;
      if (groupId) {
        await api(`/api/labels/${labelId}/groups/${groupId}`, { method: 'POST' });
        manageLabelAccess(labelId, document.getElementById('label-access-name').textContent);
        renderLabels();
      }
    }

    async function removeGroupFromLabel(labelId, groupId) {
      await api(`/api/labels/${labelId}/groups/${groupId}`, { method: 'DELETE' });
      manageLabelAccess(labelId, document.getElementById('label-access-name').textContent);
      renderLabels();
    }

    // Admin views
    async function loadUserServers() {
      const userId = document.getElementById('admin-user-select').value;
      if (!userId) {
        document.getElementById('admin-user-servers').classList.add('hidden');
        return;
      }
      const servers = await api(`/api/user-servers/${userId}`);
      document.getElementById('admin-user-servers-list').innerHTML = servers.length ? servers.map(s => {
        let syncStatus;
        if (!s.last_deployed_at) {
          syncStatus = '<div class="sync-status"><span class="dot dot-gray"></span> Never deployed</div>';
        } else if (s.is_up_to_date) {
          syncStatus = '<div class="sync-status"><span class="dot dot-green"></span> Up to date</div>';
        } else {
          syncStatus = '<div class="sync-status"><span class="dot dot-yellow"></span> Needs sync</div>';
        }
        return `<tr><td>${s.hostname}</td><td>${s.description || '-'}</td><td>${syncStatus}</td></tr>`;
      }).join('') : '<tr><td colspan="3">No servers accessible</td></tr>';
      document.getElementById('admin-user-servers').classList.remove('hidden');
    }

    async function loadServerAccess() {
      const serverId = document.getElementById('admin-server-select').value;
      if (!serverId) {
        document.getElementById('server-access-info').classList.add('hidden');
        return;
      }
      const access = await api(`/api/server-access/${serverId}`);

      document.getElementById('server-access-users').innerHTML = access.users.map(u => `
        <tr>
          <td>${u.name || '-'}</td>
          <td>${u.email}</td>
          <td><span class="tag">${u.group_name}</span></td>
          <td>${u.public_key ? '<span class="tag tag-green">Yes</span>' : '<span class="tag">No</span>'}</td>
        </tr>
      `).join('') || '<tr><td colspan="4">No users have access</td></tr>';

      document.getElementById('server-access-info').classList.remove('hidden');
    }

    function viewUserAccess(userId) {
      document.querySelector('[data-tab="access-admin"]').click();
      document.getElementById('admin-user-select').value = userId;
      loadUserServers();
    }

    // Start app
    init();
  </script>
</body>
</html>
